pipeline {
    agent {
        label 'DSS'
    }
	parameters {
		string(name: 'Branch', defaultValue: 'temp-develop', description: 'Enter the branch to deploy?')
	}
    stages {
        stage('devops-config Code checkout') {
            steps {
                echo 'Going to Checkout devops-config from Git'
		sh """
			cd /home/paywalletdevops/
			sudo rm -rf devops-config
                """
		git branch: 'master', credentialsId: 'Github-Key', url: 'https://github.com/Maveric-Digital/devops-config.git'
                echo 'Completed Checkout devops-config from Git'
            }
        }
	stage('accounts-management-service Code checkout') {
            steps {
                echo 'Going to Checkout devops-config from Git'
		sh """
			cd /home/paywalletdevops/new_paywallet_backend_services/
			sudo rm -rf accounts-management-service
                """
		git branch: '${params.Branch}', credentialsId: 'Github-Key', url: 'https://github.com/Maveric-Digital/accounts-management-service.git'
                echo 'Completed Checkout accounts-management-service from Git'
            }
        }
	stage ('Remove the docker container and images') {
            steps {
                sh """
			sudo docker rm -f accounts-management-service_container
			sudo docker rmi accounts-management-service
                """
            }
        }
	stage ('Maven Build for service') {
            steps {
                sh """
		    cd /home/paywalletdevops/new_paywallet_backend_services/accounts-management-service
		    cp /home/paywalletdevops/devops-config/Dev-env/accountmanagement-service/Dockerfile-uat .
		    cp /home/paywalletdevops/devops-config/Dev-env/accountmanagement-service/docker-compose-uat.yml .
		    mvn clean install -DskipTests
                """
            }
        }
	stage ('Sonarqube') {
            steps {
                sh """
		    mvn sonar:sonar \
			-Dsonar.projectKey=PayWallet-UAT-AccountManagement-API \
			-Dsonar.host.url=http://sonar-dev.paywalletllc.com:9000 \
			-Dsonar.login=85202c46000da8b911cae32f8ebe661224b49974 \
			-Dsonar.name=UAT-accountmanagement-service
                """
            }
        }
    	stage ('Run Docker-compose') {
            steps {
                sh """
                    sudo docker-compose -f docker-compose-uat.yml up -d
                """
            }
        }
    }
    post {
        always {
            cleanWs()
        }
      }
}
